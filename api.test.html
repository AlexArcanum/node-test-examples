<!DOCTYPE html>

<html>
<head>
  <title>api.test.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>api.test.coffee</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="api.test.html">
                    api.test.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="browser.test.html">
                    browser.test.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="helpers.test.html">
                    helpers.test.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="testHelpers.html">
                    testHelpers.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="users.test.html">
                    users.test.coffee
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        <p>Codes you should look at: </p>
<ul>
<li><a href="https://github.com/conancat/node-test-examples/blob/master/src/test/api.test.coffee">helpers.test.coffee</a></li>
</ul>
<p>Related pages: </p>
<ul>
<li><a href="http://conancat.github.com/node-test-examples/users.html">Function code</a></li>
</ul>
<h2>Setting up</h2>
<p><em>IMPORTANT</em>: Set your environment as testing, and have environment specific 
configurations. You DON&#39;T want to mess with your production database while
you&#39;re working on testing! To see how we setup environment specific configurations, 
check out our <a href="http://conancat.github.com/node-test-examples/conf.html">configuration file</a>.</p>

        
          <div class='highlight'><pre>process.env.NODE_ENV = <span class="string">"testing"</span></pre></div>
        
      
        
        <p>Here we&#39;re declaring some variables that we&#39;re gonna use. </p>
<ul>
<li>Use Chai&#39;s expect for assertion</li>
<li>Get the test helper functions</li>
<li>Get the Request package for API testing</li>
<li>Setup some placeholder variables</li>
</ul>

        
          <div class='highlight'><pre>{expect} = require <span class="string">"chai"</span>

testHelpers = require <span class="string">"./testHelpers"</span>

request = require <span class="string">"request"</span>

serverPath = <span class="string">""</span></pre></div>
        
      
        
        <h2>Begin Test</h2>
<p>Before we begin, let&#39;s clear the database to get rid of any old data, 
and start the server in our test. Our startServer() function returns the 
serverPath which we will use to make test API calls to later. </p>
<p>To understand more about how our helpers are doing this, 
check out the <a href="http://conancat.github.com/node-test-examples/testHelpers.html">testHelpers</a> oage. </p>

        
          <div class='highlight'><pre>before (done) -&gt;
  <span class="property">@timeout</span> <span class="number">10000</span>

  testHelpers.clearDatabase -&gt;
    testHelpers.startServer (err, result) -&gt;
      <span class="keyword">if</span> err <span class="keyword">then</span> <span class="keyword">return</span> done err
      serverPath = result
      done()</pre></div>
        
      
        
        <p>For this test, we&#39;re doing a call to our POST /submit route. We fired up our server, 
and with the Request module we POST some requests to see if it&#39;s returning the desired results. 
We check if it is returning a JSON result, and if the parts of the result are correct. </p>
<p>In short, our process is: </p>
<p>Perfect Input
<em> Make a call to POST <code>http://localhost:&lt;port&gt;/submit&amp;name=&lt;name&gt;&amp;age=&lt;age&gt;&amp;food=&lt;food&gt;</code>
</em> Should return <code>{&quot;meta&quot;:{&quot;status&quot;:200, &quot;msg&quot;:&quot;ok&quot;}}</code></p>
<p>Error input
<em> Make a call to <code>POST http://localhost:&lt;port&gt;/submit&amp;name=&lt;name&gt;&amp;age=&lt;wrong age&gt;&amp;food=&lt;food&gt;</code>
</em> Should return <code>{&quot;meta&quot;: {&quot;status&quot;: 400, &quot;msg&quot;: &quot;Error message&quot;}}</code></p>
<p>First let&#39;s create a suite...</p>

        
          <div class='highlight'><pre>describe <span class="string">"API test example: POST /submit"</span>, -&gt;</pre></div>
        
      
        
        <p>Test with a perfect input. Oh yeah!</p>

        
          <div class='highlight'><pre>  describe <span class="string">"Perfect input"</span>, -&gt;
    response = {}

    before (done) -&gt;
      endpoint = serverPath + <span class="string">"/submit"</span>

      request.post endpoint,
        headers:
          <span class="string">"X-Requested-With"</span>: <span class="string">"XMLHttpRequest"</span>
        json: <span class="literal">true</span>
        form:
          name: <span class="string">"Caesar"</span>
          age: <span class="number">13</span>
          food: <span class="string">"sandwich"</span>
      , (err, res, body) -&gt;
        response = body
        done()

    it <span class="string">"should return a JSON object"</span>, -&gt;
      expect(response).to.be.an(<span class="string">"object"</span>)

    it <span class="string">"should contain the meta data"</span>, -&gt;
      expect(response.meta).to.be.an(<span class="string">"object"</span>)

    it <span class="string">"should return status of 200"</span>, -&gt;
      expect(response.meta.status).to.be.equal(<span class="number">200</span>)

    it <span class="string">"should return 'ok' message"</span>, -&gt;
      expect(response.meta.msg).to.be.equal(<span class="string">"ok"</span>)</pre></div>
        
      
        
        <p>Test with a faulty input. We&#39;re entering a wrong AGE! </p>

        
          <div class='highlight'><pre>  describe <span class="string">"Error input"</span>, -&gt;
    response = {}

    before (done) -&gt;
      endpoint = serverPath + <span class="string">"/submit"</span>

      request.post endpoint,
        headers:
          <span class="string">"X-Requested-With"</span>: <span class="string">"XMLHttpRequest"</span>
        json: <span class="literal">true</span>
        form:
          name: <span class="string">"Caesar"</span>
          age: <span class="string">"donkey"</span> 
          food: <span class="string">"sandwich"</span>
      , (err, res, body) -&gt;
        response = body
        done()

    it <span class="string">"should return a JSON object"</span>, -&gt;
      expect(response).to.be.an(<span class="string">"object"</span>)

    it <span class="string">"should contain the meta data"</span>, -&gt;
      expect(response.meta).to.be.an(<span class="string">"object"</span>)

    it <span class="string">"should return status of 403"</span>, -&gt;
      expect(response.meta.status).to.be.equal(<span class="number">400</span>)

    it <span class="string">"should return error message saying 'Age must be a number'"</span>, -&gt;
      expect(response.meta.msg).to.be.equal(<span class="string">"Age must be a number"</span>)</pre></div>
        
      
        
        <p>After we&#39;re done...</p>
<p>Clear the database again, and stop the server from running. We&#39;re being clean, you know?</p>

        
          <div class='highlight'><pre>after (done) -&gt;
  testHelpers.clearDatabase -&gt;
    testHelpers.stopServer serverPath, -&gt;
      done()</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
