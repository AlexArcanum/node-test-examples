<!DOCTYPE html>

<html>
<head>
  <title>users.test.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>users.test.coffee</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="api.test.html">
                    api.test.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="browser.test.html">
                    browser.test.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="helpers.test.html">
                    helpers.test.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="testHelpers.html">
                    testHelpers.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="users.test.html">
                    users.test.coffee
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        <p>Codes you should look at: 
* <a href="https://github.com/conancat/node-test-examples/blob/master/src/test/users.test.coffee">users.test.coffee</a></p>
<p>Related pages: 
* <a href="http://conancat.github.com/node-test-examples/users.html">Function code</a></p>
<h2>Setting up</h2>
<p><em>IMPORTANT</em>: Set your environment as testing, and have environment specific 
configurations. You DON&#39;T want to mess with your production database while
you&#39;re working on testing! To see how we setup environment specific configurations, 
check out our <a href="http://conancat.github.com/node-test-examples/conf.html">configuration file</a>.</p>

        
          <div class='highlight'><pre>process.env.NODE_ENV = <span class="string">"testing"</span></pre></div>
        
      
        
        <p>Here we&#39;re declaring some variables that we&#39;re gonna use. </p>
<ul>
<li><h1>Use Chai module for assertion. We&#39;ll be using the <a href="http://chaijs.com/guide/styles/"><code>expect</code></a> interface here.</h1>
</li>
<li>Get the test helper functions</li>
<li>Get the main module that we&#39;ll be testing <code>users</code></li>
<li>Require the database model so that we can make calls from our test to the database
to make sure things are being properly created</li>
</ul>

        
          <div class='highlight'><pre>{expect} = require <span class="string">"chai"</span>

testHelpers = require <span class="string">"./testHelpers"</span>

users = require <span class="string">"../lib/users"</span>

{User} = require <span class="string">"../lib/models"</span></pre></div>
        
      
        
        <h2>Begin Test</h2>
<p>Note: You&#39;ll notice that there are some <code>done</code> calls being called here. This is a cool 
thing about Mocha -- for every test that you write, you can use the <code>done</code> call to specify
that it is an asynchronous code, and will only be completed after you call the <code>done</code> function. 
If no <code>done</code> is passed, then it will assume that it&#39;s a synchronous test. </p>
<p>For more info, check out Mocha&#39;s <a href="http://visionmedia.github.com/mocha/">documentation</a>. </p>
<p>Before we begin... </p>
<ul>
<li>Clear the database before doing any operations, so that we will not 
be affected by any old data. </li>
</ul>

        
          <div class='highlight'><pre>before (done) -&gt;
  testHelpers.clearDatabase done</pre></div>
        
      
        
        <p>Let&#39;s begin the party!</p>
<h3>getUser()</h3>
<p>First, we need to populate 
the database with some mock users. These input are defined in the 
<code>mocks/users.json</code> file which we will require and insert them into the database. 
Then we can safely test the getUser function if it&#39;s working or not. </p>
<p>After we&#39;re done testing with a perfect input and getting the results that 
we want, we will test the behaviors of validation as well to see if 
bad inputs are throwing errors as we will expect them to be. We don&#39;t want 
bad data to go into the database, they will cause trouble later! </p>

        
          <div class='highlight'><pre>describe <span class="string">"Database test example: Getting data from db"</span>, -&gt;
  {getUser} = users</pre></div>
        
      
        
        <p>Create mock items in database first</p>

        
          <div class='highlight'><pre>  before (done) -&gt;
    mockUsers = require <span class="string">"./mocks/users"</span>
    User.create mockUsers, done</pre></div>
        
      
        
        <p>Let&#39;s test with a normal call, using the name as the argument. </p>

        
          <div class='highlight'><pre>  it <span class="string">"should get the user by supplying the name in input"</span>, (done) -&gt;

    data = 
      name: <span class="string">"Caesar"</span>

    getUser data, (err, result) -&gt;
      expect(result.name).to.be.equal(<span class="string">"Caesar"</span>)
      done()</pre></div>
        
      
        
        <p>After that, let&#39;s test with the required argument, and an optional argument
and see if it is returning the result that we expected. </p>

        
          <div class='highlight'><pre>  it <span class="string">"should return user that has age specified if specified"</span>, (done) -&gt;
    data = 
      name: <span class="string">"Caesar"</span>
      age: <span class="number">15</span>

    getUser data, (err, result) -&gt;
      expect(result.food).to.be.equal(<span class="string">"salad"</span>)
      done()</pre></div>
        
      
        
        <p>The function works perfectly! Now we need to see if we give it some weird input
and if it returns the results we wanted. </p>

        
          <div class='highlight'><pre>  it <span class="string">"should return null if no users are found"</span>, (done) -&gt;
    data = 
      name: <span class="string">"Weird ass name"</span>

    getUser data, (err, result) -&gt;
      expect(result).to.be.<span class="literal">null</span>
      done()

  it <span class="string">"should return error if no name is specified"</span>, (done) -&gt;
    data = 
      age: <span class="number">10</span>

    getUser data, (err, result) -&gt;
      expect(err).to.be.equal(<span class="string">"Name is required"</span>)
      done()</pre></div>
        
      
        
        <h3>createOrUpdateUser()</h3>
<p>For this function, we don&#39;t have to 
create mocks in the database. Instead we call the function directly, 
check if it returns no error, and we will make a call from the test 
file to the database and see if the entry is being inserted correctly. </p>
<p>We will also make some bad calls to the function on purpose just to see
if the validations are working correctly when we call the function, 
so that no jackasses will pass in some weird input and it screws up 
our database entries. We don&#39;t like screwed up databases, do we? </p>

        
          <div class='highlight'><pre>describe <span class="string">"Database test example: Creating or updating data in db"</span>, -&gt;

  {createOrUpdateUser} = users</pre></div>
        
      
        
        <p>The perfect scenario! Let&#39;s make a call to the API, see if returns no 
errors, and then we check the database if things are being saved correctly</p>

        
          <div class='highlight'><pre>  
  it <span class="string">"should create user successfully given a perfect input"</span>, (done) -&gt;

    data = 
      name: <span class="string">"Grey"</span>
      age: <span class="number">10</span>
      food: <span class="string">"banana"</span>

    createOrUpdateUser data, (err) -&gt;

      expect(err).to.be.<span class="literal">null</span>

      User.findOne name: data.name, (err, result) -&gt;
        expect(result).to.be.an(<span class="string">"object"</span>)
        done()</pre></div>
        
      
        
        <p>Let&#39;s test the validation function if the function returns
errors correctly if we pass in some bad inputs</p>

        
          <div class='highlight'><pre>  it <span class="string">"should throw error if missing name in input"</span>, (done) -&gt;
    data = 
      age: <span class="number">10</span>
      food: <span class="string">"banana"</span>

    createOrUpdateUser data, (err) -&gt;
      expect(err).to.be.equal(<span class="string">"Name is required"</span>)
      done()

  it <span class="string">"should throw error if missing age in input"</span>, (done) -&gt;
    data = 
      name: <span class="string">"Grey"</span>
      food: <span class="string">"banana"</span>

    createOrUpdateUser data, (err) -&gt;
      expect(err).to.be.equal(<span class="string">"Age is required"</span>)
      done()

  it <span class="string">"should throw error if age is not a number"</span>, (done) -&gt;
    data = 
      name: <span class="string">"Grey"</span>
      age: <span class="string">"donkey"</span>
      food: <span class="string">"banana"</span>

    createOrUpdateUser data, (err) -&gt;
      expect(err).to.be.equal(<span class="string">"Age must be a number"</span>)
      done()</pre></div>
        
      
        
        <p>After we&#39;re done...</p>
<p>Clear the database again, and stop the server from running. We&#39;re being clean, you know?</p>

        
          <div class='highlight'><pre>after (done) -&gt;
  testHelpers.clearDatabase done</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
